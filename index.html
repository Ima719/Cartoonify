<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù…Ø­ÙˆÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ ÙƒØ±ØªÙˆÙ† 2D</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 15px;
      background: #f0f0f0;
    }
    canvas {
      border: 2px solid #333;
      margin: 10px;
      max-width: 100%;
      background: white;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background: #e91e63;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    h1 { color: #212121; }
  </style>
</head>
<body>
  <h1>ğŸ¨ Ù…Ø­ÙˆÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ ÙƒØ±ØªÙˆÙ† 2D</h1>
  <p>Ø§Ø®ØªØ± ØµÙˆØ±Ø© â€” Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ù†Ù…Ø· Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© Ø«Ù†Ø§Ø¦ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯!</p>
  
  <input type="file" id="imageLoader" accept="image/*" />
  
  <div class="container">
    <div>
      <h3>Ø§Ù„Ø£ØµÙ„ÙŠØ©</h3>
      <canvas id="originalCanvas"></canvas>
    </div>
    <div>
      <h3>Ø§Ù„ÙƒØ±ØªÙˆÙ† 2D</h3>
      <canvas id="cartoonCanvas"></canvas>
    </div>
  </div>
  <button onclick="downloadCartoon()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ±ØªÙˆÙ†ÙŠØ©</button>

  <script>
    function cartoonify2D(ctx, width, height) {
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;

      // 1. ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Color Quantization)
      const levels = 4; // Ø¹Ø¯Ø¯ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù„ÙˆÙ†
      for (let i = 0; i < data.length; i += 4) {
        data[i]     = Math.floor(data[i] / (256 / levels)) * (256 / levels);
        data[i + 1] = Math.floor(data[i + 1] / (256 / levels)) * (256 / levels);
        data[i + 2] = Math.floor(data[i + 2] / (256 / levels)) * (256 / levels);
      }
      ctx.putImageData(imageData, 0, 0);

      // 2. Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø­ÙˆØ§Ù ÙˆØ±Ø³Ù… Ø®Ø·ÙˆØ· Ø³ÙˆØ¯Ø§Ø¡
      const edgeImageData = ctx.getImageData(0, 0, width, height);
      const edgeData = edgeImageData.data;
      const newData = new Uint8ClampedArray(edgeData.length);

      // Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      for (let i = 0; i < edgeData.length; i++) {
        newData[i] = edgeData[i];
      }

      // ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¨Ø³ÙŠØ· (Sobel-like)
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          const idx = (y * width + x) * 4;

          // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ø¨ÙŠÙ† Ø§Ù„Ø¬ÙŠØ±Ø§Ù†
          let diff = 0;
          for (let c = 0; c < 3; c++) {
            const center = edgeData[idx + c];
            const left   = edgeData[(y * width + x - 1) * 4 + c];
            const right  = edgeData[(y * width + x + 1) * 4 + c];
            const top    = edgeData[((y - 1) * width + x) * 4 + c];
            const bottom = edgeData[((y + 1) * width + x) * 4 + c];
            diff += Math.abs(center - left) + Math.abs(center - right) +
                    Math.abs(center - top) + Math.abs(center - bottom);
          }

          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø®ØªÙ„Ø§Ù ÙƒØ¨ÙŠØ±Ù‹Ø§ â†’ Ø§Ø±Ø³Ù… Ø®Ø·Ù‹Ø§ Ø£Ø³ÙˆØ¯
          if (diff > 150) {
            newData[idx] = 0;       // R
            newData[idx + 1] = 0;   // G
            newData[idx + 2] = 0;   // B
          } else {
            // Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø¨Ø³Ø·
            newData[idx] = data[idx];
            newData[idx + 1] = data[idx + 1];
            newData[idx + 2] = data[idx + 2];
          }
        }
      }

      const finalImageData = new ImageData(newData, width, height);
      ctx.putImageData(finalImageData, 0, 0);
    }

    let img = new Image();
    img.onload = function() {
      const maxWidth = 500;
      const scale = Math.min(1, maxWidth / img.width);
      const width = img.width * scale;
      const height = img.height * scale;

      // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
      const orig = document.getElementById('originalCanvas');
      orig.width = width;
      orig.height = height;
      orig.getContext('2d').drawImage(img, 0, 0, width, height);

      // ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØ±ØªÙˆÙ† 2D
      const cartoon = document.getElementById('cartoonCanvas');
      cartoon.width = width;
      cartoon.height = height;
      const ctx = cartoon.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      cartoonify2D(ctx, width, height);
    };

    document.getElementById('imageLoader').onchange = function(e) {
      if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = ev => img.src = ev.target.result;
        reader.readAsDataURL(e.target.files[0]);
      }
    };

    function downloadCartoon() {
      const canvas = document.getElementById('cartoonCanvas');
      if (canvas.width === 0) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ù‹Ø§!");
        return;
      }
      const a = document.createElement('a');
      a.download = 'cartoon-2d.png';
      a.href = canvas.toDataURL();
      a.click();
    }
  </script>
</body>
</html>
