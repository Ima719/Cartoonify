<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>محول الصور إلى كرتون 2D</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 15px;
      background: #f0f0f0;
    }
    canvas {
      border: 2px solid #333;
      margin: 10px;
      max-width: 100%;
      background: white;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background: #e91e63;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    h1 { color: #212121; }
  </style>
</head>
<body>
  <h1>🎨 محول الصور إلى كرتون 2D</h1>
  <p>اختر صورة — سيتم تحويلها إلى نمط رسوم متحركة ثنائية الأبعاد!</p>
  
  <input type="file" id="imageLoader" accept="image/*" />
  
  <div class="container">
    <div>
      <h3>الأصلية</h3>
      <canvas id="originalCanvas"></canvas>
    </div>
    <div>
      <h3>الكرتون 2D</h3>
      <canvas id="cartoonCanvas"></canvas>
    </div>
  </div>
  <button onclick="downloadCartoon()">⬇️ تحميل الصورة الكرتونية</button>

  <script>
    function cartoonify2D(ctx, width, height) {
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;

      // 1. تقليل الألوان (Color Quantization)
      const levels = 4; // عدد درجات اللون
      for (let i = 0; i < data.length; i += 4) {
        data[i]     = Math.floor(data[i] / (256 / levels)) * (256 / levels);
        data[i + 1] = Math.floor(data[i + 1] / (256 / levels)) * (256 / levels);
        data[i + 2] = Math.floor(data[i + 2] / (256 / levels)) * (256 / levels);
      }
      ctx.putImageData(imageData, 0, 0);

      // 2. اكتشاف الحواف ورسم خطوط سوداء
      const edgeImageData = ctx.getImageData(0, 0, width, height);
      const edgeData = edgeImageData.data;
      const newData = new Uint8ClampedArray(edgeData.length);

      // نسخ البيانات
      for (let i = 0; i < edgeData.length; i++) {
        newData[i] = edgeData[i];
      }

      // كشف الحواف البسيط (Sobel-like)
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          const idx = (y * width + x) * 4;

          // حساب التباين بين الجيران
          let diff = 0;
          for (let c = 0; c < 3; c++) {
            const center = edgeData[idx + c];
            const left   = edgeData[(y * width + x - 1) * 4 + c];
            const right  = edgeData[(y * width + x + 1) * 4 + c];
            const top    = edgeData[((y - 1) * width + x) * 4 + c];
            const bottom = edgeData[((y + 1) * width + x) * 4 + c];
            diff += Math.abs(center - left) + Math.abs(center - right) +
                    Math.abs(center - top) + Math.abs(center - bottom);
          }

          // إذا كان الاختلاف كبيرًا → ارسم خطًا أسود
          if (diff > 150) {
            newData[idx] = 0;       // R
            newData[idx + 1] = 0;   // G
            newData[idx + 2] = 0;   // B
          } else {
            // احتفظ باللون المبسط
            newData[idx] = data[idx];
            newData[idx + 1] = data[idx + 1];
            newData[idx + 2] = data[idx + 2];
          }
        }
      }

      const finalImageData = new ImageData(newData, width, height);
      ctx.putImageData(finalImageData, 0, 0);
    }

    let img = new Image();
    img.onload = function() {
      const maxWidth = 500;
      const scale = Math.min(1, maxWidth / img.width);
      const width = img.width * scale;
      const height = img.height * scale;

      // عرض الصورة الأصلية
      const orig = document.getElementById('originalCanvas');
      orig.width = width;
      orig.height = height;
      orig.getContext('2d').drawImage(img, 0, 0, width, height);

      // تطبيق تأثير الكرتون 2D
      const cartoon = document.getElementById('cartoonCanvas');
      cartoon.width = width;
      cartoon.height = height;
      const ctx = cartoon.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      cartoonify2D(ctx, width, height);
    };

    document.getElementById('imageLoader').onchange = function(e) {
      if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = ev => img.src = ev.target.result;
        reader.readAsDataURL(e.target.files[0]);
      }
    };

    function downloadCartoon() {
      const canvas = document.getElementById('cartoonCanvas');
      if (canvas.width === 0) {
        alert("يرجى اختيار صورة أولًا!");
        return;
      }
      const a = document.createElement('a');
      a.download = 'cartoon-2d.png';
      a.href = canvas.toDataURL();
      a.click();
    }
  </script>
</body>
</html>
